<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mezar Taşı Okuyucu - Arapça-Türkçe Çeviri & Kamera</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body { font-family: Arial, sans-serif; background-color: #f8f9fa; padding: 20px; }
  .camera-container { width: 100%; height: 300px; background-color: #000; margin-bottom: 20px; border-radius: 8px; overflow: hidden; position: relative; }
  #camera-feed { width: 100%; height: 100%; object-fit: cover; }
  .result-card { background-color: #fff; border-radius: 8px; padding: 15px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .history-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s; }
  .history-item:hover { background-color: #f1f1f1; }
  .osmanlica-font { font-family: 'Lateef', serif; font-size: 1.5rem; text-align: right; }
  .btn-group { margin-bottom: 15px; }
</style>
</head>
<body>

<div class="container">
  <h1 class="text-center my-4">Mezar Taşı Okuyucu <span aria-hidden="true">📜</span></h1>

  <div class="btn-group d-flex justify-content-between" role="group">
    <button id="start-camera-btn" class="btn btn-primary flex-grow-1 me-1">📷 Kamera Aç</button>
    <button id="switch-camera-btn" class="btn btn-secondary flex-grow-1 ms-1" disabled>🔄 Kamera Değiştir</button>
  </div>

  <div class="camera-container">
    <video id="camera-feed" autoplay muted playsinline></video>
  </div>

  <canvas id="capture-canvas" width="800" height="300" style="display:none;"></canvas>

  <div class="d-grid gap-2 mb-3">
    <button id="scan-btn" class="btn btn-success" disabled>📸 Fotoğraf Çek ve Tara</button>
  </div>

  <div class="result-card">
    <h3>OCR Sonucu (Arapça):</h3>
    <div id="ocr-result" class="osmanlica-font">---</div>
    <h3 class="mt-3">Türkçe Çeviri:</h3>
    <div id="translation" style="white-space: pre-wrap;">---</div>
  </div>

  <h4 class="mt-4">Geçmiş Kayıtlar</h4>
  <div id="history" class="result-card"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script>
  const HISTORY_KEY = 'ocrHistory';
  let currentStream = null;
  let useFrontCamera = false;

  // Basit Arapça -> Türkçe sözlük
  const ceviriSozlugu = {
    "شيخ": "Şeyh",
    "أفندي": "Efendi",
    "باشا": "Paşa",
    "بيك": "Bey",
    "خانم": "Hanım",
    "مولانا": "Mevlana",
    "سلطان": "Sultan",
    // Daha fazlası eklenebilir
  };

  // Arapça metni Türkçeye çevir
  function arapcaToTurkce(text) {
    let cevrilen = text;
    for (const [arapca, turkce] of Object.entries(ceviriSozlugu)) {
      const regex = new RegExp(arapca, 'g');
      cevrilen = cevrilen.replace(regex, turkce);
    }
    return cevrilen;
  }

  async function startCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
    try {
      const constraints = { video: { facingMode: useFrontCamera ? "user" : "environment" } };
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      const video = document.getElementById('camera-feed');
      video.srcObject = currentStream;
      document.getElementById('scan-btn').disabled = false;
      document.getElementById('switch-camera-btn').disabled = false;
      document.getElementById('start-camera-btn').textContent = "📷 Kamera Kapat";
    } catch (e) {
      alert("Kamera açılamadı: " + e.message);
    }
  }

  function stopCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(t => t.stop());
      currentStream = null;
    }
    const video = document.getElementById('camera-feed');
    video.srcObject = null;
    document.getElementById('scan-btn').disabled = true;
    document.getElementById('switch-camera-btn').disabled = true;
    document.getElementById('start-camera-btn').textContent = "📷 Kamera Aç";
  }

  document.getElementById('start-camera-btn').addEventListener('click', () => {
    if (currentStream) stopCamera();
    else startCamera();
  });

  document.getElementById('switch-camera-btn').addEventListener('click', () => {
    useFrontCamera = !useFrontCamera;
    startCamera();
  });

  async function scanAndRecognize() {
    if (!currentStream) {
      alert("Lütfen önce kamerayı açın.");
      return;
    }
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('capture-canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageDataURL = canvas.toDataURL('image/png');

    document.getElementById('ocr-result').textContent = "Taranıyor...";
    document.getElementById('translation').textContent = "---";

    try {
      const worker = await Tesseract.createWorker({ logger: m => console.log(m) });
      await worker.loadLanguage('ara+tur');
      await worker.initialize('ara+tur');
      const { data: { text } } = await worker.recognize(imageDataURL);
      await worker.terminate();

      document.getElementById('ocr-result').textContent = text;

      const turkceMetin = arapcaToTurkce(text);
      document.getElementById('translation').textContent = turkceMetin;

      saveHistory(text, turkceMetin);
    } catch (err) {
      console.error(err);
      document.getElementById('ocr-result').textContent = "Hata oluştu.";
      document.getElementById('translation').textContent = "---";
    }
  }

  function saveHistory(ocrText, turkceText) {
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    const item = { time: new Date().toISOString(), ocrText, turkceText };
    history.unshift(item);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    renderHistory();
  }

  function renderHistory() {
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    const container = document.getElementById('history');
    container.innerHTML = '';
    history.forEach(item => {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.textContent = `📌 ${new Date(item.time).toLocaleString()}`;
      div.onclick = () => {
        document.getElementById('ocr-result').textContent = item.ocrText;
        document.getElementById('translation').textContent = item.turkceText;
      };
      container.appendChild(div);
    });
  }

  document.getElementById('scan-btn').addEventListener('click', scanAndRecognize);

  window.addEventListener('load', () => {
    renderHistory();
  });
</script>

</body>
</html>
