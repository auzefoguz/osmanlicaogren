<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mezar TaÅŸÄ± Okuyucu GeliÅŸmiÅŸ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f8f9fa;
    padding: 20px;
  }
  .camera-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    height: 300px;
    background-color: #000;
    margin-bottom: 10px;
    border-radius: 8px;
    overflow: hidden;
  }
  #camera-feed {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #capture-canvas {
    display: none;
  }
  .result-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .history-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .history-item:hover {
    background-color: #f1f1f1;
  }
  .osmanlica-font {
    font-family: 'Lateef', serif;
    font-size: 1.5rem;
    text-align: right;
  }
  mark {
    background-color: #fffa8b;
    cursor: help;
  }
  .btn-group {
    margin-bottom: 10px;
  }
  @media(max-width:600px) {
    .camera-container {
      height: 200px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1 class="text-center my-4">Mezar TaÅŸÄ± Okuyucu GeliÅŸmiÅŸ <span aria-hidden="true">ğŸ“œ</span></h1>

  <div class="btn-group d-flex justify-content-between mb-2" role="group">
    <button id="start-camera-btn" class="btn btn-primary flex-grow-1 me-1">ğŸ“· Kamera AÃ§</button>
    <button id="switch-camera-btn" class="btn btn-secondary flex-grow-1 ms-1" disabled>ğŸ”„ Kamera DeÄŸiÅŸtir</button>
  </div>

  <div class="camera-container">
    <video id="camera-feed" autoplay muted playsinline></video>
  </div>

  <canvas id="capture-canvas" width="800" height="300"></canvas>

  <div class="d-grid gap-2 my-3">
    <button id="scan-btn" class="btn btn-success" disabled>ğŸ“¸ FotoÄŸraf Ã‡ek ve Tara</button>
  </div>

  <div class="d-grid gap-2 mb-3">
    <input type="file" id="file-input" accept="image/*" class="form-control" />
  </div>

  <div class="result-card">
    <h3>SonuÃ§:</h3>
    <div id="ocr-result" class="osmanlica-font">---</div>
    <div id="translation" class="mt-2">---</div>
    <div id="explanation" class="text-muted mt-2 small">---</div>
  </div>

  <h4 class="mt-4">Metin BÃ¶lÃ¼mleri</h4>
  <div class="result-card" id="text-sections" style="white-space: pre-wrap;">---</div>

  <h4 class="mt-5">ğŸ“ OsmanlÄ±ca Temel Harfler ve AnlamlarÄ±</h4>
  <div id="education-module" class="result-card" style="font-size: 1rem; line-height: 1.5;">
    <p><b>Ø§ (elif)</b> â€” A, E sesi</p>
    <p><b>Ø¨ (be)</b> â€” B sesi</p>
    <p><b>Ø¬ (cim)</b> â€” C sesi</p>
    <p><b>Ø¯ (dal)</b> â€” D sesi</p>
    <p><b>Ø± (re)</b> â€” R sesi</p>
    <p><b>Ø³ (sin)</b> â€” S sesi</p>
    <p><b>Ùƒ (kef)</b> â€” K sesi</p>
    <p><b>Ù„ (lam)</b> â€” L sesi</p>
    <p><b>Ù… (mim)</b> â€” M sesi</p>
    <p><b>Ù† (nun)</b> â€” N sesi</p>
    <p><b>Ù‡ (he)</b> â€” H sesi</p>
    <p>... ve diÄŸer harfler iÃ§in de eklenebilir.</p>
    <small><i>Not: OsmanlÄ±ca Arap harfleriyle yazÄ±lÄ±r. Bu modÃ¼l temel Ã¶ÄŸrenim amaÃ§lÄ±dÄ±r.</i></small>
  </div>

  <h4 class="mt-4">GeÃ§miÅŸ KayÄ±tlar</h4>
  <div id="history" class="result-card"></div>
</div>

<!-- Tesseract OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<!-- QR Kod Okuyucu -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
  const HISTORY_KEY = 'ocrHistory';

  let currentStream = null;
  let useFrontCamera = false; // Ã–n kamera (true) / arka kamera (false)

  // Ã–zel kelimeler sÃ¶zlÃ¼ÄŸÃ¼
  const sozluk = {
    "ÅEYH": "DinÃ® lider, mÃ¼rÅŸid",
    "EFENDÄ°": "SaygÄ± ifadesi, bey",
    "PAÅA": "AskerÃ® rÃ¼tbe",
    "BEY": "YÃ¶netici, bey",
    "HANIM": "KadÄ±nlar iÃ§in saygÄ±",
    "MEVLANA": "SaygÄ±deÄŸer, unvan",
    "SULTAN": "HÃ¼kÃ¼mdar, kraliyet unvanÄ±"
  };

  async function startCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }

    const constraints = {
      video: {
        facingMode: useFrontCamera ? "user" : "environment"
      }
    };

    try {
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      const video = document.getElementById('camera-feed');
      video.srcObject = currentStream;
      document.getElementById('scan-btn').disabled = false;
      document.getElementById('switch-camera-btn').disabled = false;
      document.getElementById('start-camera-btn').textContent = "ğŸ“· Kamera Kapat";
    } catch (err) {
      alert("Kamera aÃ§Ä±lamadÄ±: " + err.message);
    }
  }

  function stopCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    const video = document.getElementById('camera-feed');
    video.srcObject = null;
    document.getElementById('scan-btn').disabled = true;
    document.getElementById('switch-camera-btn').disabled = true;
    document.getElementById('start-camera-btn').textContent = "ğŸ“· Kamera AÃ§";
  }

  document.getElementById('start-camera-btn').addEventListener('click', () => {
    if (currentStream) {
      stopCamera();
    } else {
      startCamera();
    }
  });

  document.getElementById('switch-camera-btn').addEventListener('click', () => {
    useFrontCamera = !useFrontCamera;
    startCamera();
  });

  function hicriToMiladi(hicriYil) {
    return 622 + Math.floor(hicriYil * 0.97);
  }

  function highlightWords(text) {
    const words = Object.keys(sozluk);
    let escapedText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    for (const word of words) {
      const regex = new RegExp(`\\b${word}\\b`, 'gi');
      escapedText = escapedText.replace(regex, (match) => {
        return `<mark title="${sozluk[word]}">${match}</mark>`;
      });
    }
    return escapedText;
  }

  function parseTextSections(text) {
    const lines = text.trim().split(/\r?\n/).filter(l => l.trim() !== '');

    let isimSatiri = '';
    let tarihSatiri = '';
    let duaSatirlari = [];

    for (const line of lines) {
      if (!isimSatiri && /[^\d]+/.test(line)) isimSatiri = line;
      else if (!tarihSatiri && /[Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©0-9]{3,4}/.test(line)) tarihSatiri = line;
      else duaSatirlari.push(line);
    }

    return {
      isim: isimSatiri,
      tarih: tarihSatiri,
      dua: duaSatirlari.join('\n')
    };
  }

  async function performOCR(imageDataURL) {
    document.getElementById('ocr-result').textContent = "TaranÄ±yor...";
    document.getElementById('translation').textContent = "---";
    document.getElementById('explanation').textContent = "---";
    document.getElementById('text-sections').textContent = "---";

    try {
      const worker = await Tesseract.createWorker({ logger: m => console.log(m) });
      await worker.loadLanguage('ara+tur');
      await worker.initialize('ara+tur');

      const { data: { text } } = await worker.recognize(imageDataURL);

      await worker.terminate();

      // Ä°stenmeyen karakterleri temizle (Arap harfleri, Latin, rakam, /, - ve boÅŸluklar)
      let filteredText = text.replace(/[^\u0600-\u06FF\u0750-\u077F\u0590-\u05FF0-9a-zA-Z\s\/\-\n]/g, '');

      const hicriYil = (filteredText.match(/[Ù¡-Ù©]{3,4}/g) || [])[0];
      const miladiTahmin = hicriYil ? hicriToMiladi(parseInt(hicriYil.replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)))) : null;
      const explanation = miladiTahmin ? `Taranan yÄ±l: Hicri ${hicriYil} â‰ˆ Miladi ${miladiTahmin}` : "Taranan yazÄ±dan tarih Ã§Ä±karÄ±lamadÄ±.";

      const highlightedText = highlightWords(filteredText.toUpperCase());
      const sections = parseTextSections(filteredText);

      document.getElementById('ocr-result').innerHTML = highlightedText;
      document.getElementById('translation').textContent = "Not: Bu bir OCR Ã§Ä±ktÄ±sÄ±dÄ±r.";
      document.getElementById('explanation').textContent = explanation;
      document.getElementById('text-sections').innerHTML = `<b>Ä°sim / Ãœnvan:</b> ${sections.isim || '---'}<br><b>Tarih:</b> ${sections.tarih || '---'}<br><b>Dua / Metin:</b><br>${sections.dua || '---'}`;

      const item = document.createElement('div');
      item.className = 'history-item';
      item.textContent = "ğŸ“Œ Tarama - " + new Date().toLocaleTimeString();
      item.onclick = () => showHistory(filteredText, "OCR Ã‡Ä±ktÄ±sÄ±", explanation, sections, highlightedText);
      document.getElementById('history').prepend(item);

      const existing = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      existing.unshift({ text: filteredText, explanation, time: new Date().toISOString(), sections, highlightedText });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(existing));

    } catch (err) {
      console.error(err);
      document.getElementById('ocr-result').textContent = "Hata oluÅŸtu.";
    }
  }

  function showHistory(text, translation, explanation, sections, highlightedText) {
    document.getElementById('ocr-result').innerHTML = highlightedText || text;
    document.getElementById('translation').textContent = "Ã‡eviri: " + translation;
    document.getElementById('explanation').textContent = "AÃ§Ä±klama: " + explanation;

    if (sections) {
      document.getElementById('text-sections').innerHTML = `<b>Ä°sim / Ãœnvan:</b> ${sections.isim || '---'}<br><b>Tarih:</b> ${sections.tarih || '---'}<br><b>Dua / Metin:</b><br>${sections.dua || '---'}`;
    } else {
      document.getElementById('text-sections').textContent = "---";
    }
  }

  // QR veya Barkod taramasÄ±
  async function checkQRCode(imageData) {
    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if (code) {
      return code.data;
    }
    return null;
  }

  async function captureAndScan() {
    if (!currentStream) {
      alert("LÃ¼tfen Ã¶nce kamerayÄ± aÃ§Ä±n.");
      return;
    }
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('capture-canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // Ã–nce QR/Barkod kontrol et
    const qrText = await checkQRCode(imageData);
    if (qrText) {
      document.getElementById('ocr-result').textContent = "ğŸ“± QR/Barkod Bulundu: " + qrText;
      document.getElementById('translation').textContent = "---";
      document.getElementById('explanation').textContent = "Tarama QR/Barkod ile sonuÃ§landÄ±.";
      document.getElementById('text-sections').textContent = "---";
      return;
    }

    const imageDataURL = canvas.toDataURL('image/png');
    await performOCR(imageDataURL);
  }

  document.getElementById('file-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(event) {
      const imageData = event.target.result;

      // File input iÃ§in de QR kontrolÃ¼ yapalÄ±m
      const img = new Image();
      img.onload = async function() {
        const canvas = document.getElementById('capture-canvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        const qrText = await checkQRCode(imageData);
        if (qrText) {
          document.getElementById('ocr-result').textContent = "ğŸ“± QR/Barkod Bulundu: " + qrText;
          document.getElementById('translation').textContent = "---";
          document.getElementById('explanation').textContent = "Dosyadan tarama QR/Barkod ile sonuÃ§landÄ±.";
          document.getElementById('text-sections').textContent = "---";
          return;
        }

        await performOCR(imageData);
      };
      img.src = imageData;
    };
    reader.readAsDataURL(file);
  });

  document.getElementById('scan-btn').addEventListener('click', captureAndScan);

  window.addEventListener('load', () => {
    const past = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    for (const item of past) {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.textContent = "ğŸ“Œ Ã–nceki - " + new Date(item.time).toLocaleTimeString();
      div.onclick = () => showHistory(item.text, "OCR Ã‡Ä±ktÄ±sÄ±", item.explanation, item.sections, item.highlightedText);
      document.getElementById('history').appendChild(div);
    }
  });
</script>
</body>
</html>
