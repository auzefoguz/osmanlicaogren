<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mezar TaÅŸÄ± Okuyucu GeliÅŸmiÅŸ</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f8f9fa;
    padding: 20px;
  }
  .camera-container {
    position: relative;
    width: 100%;
    max-width: 800px;
    height: 300px;
    background-color: #000;
    margin-bottom: 10px;
    border-radius: 8px;
    overflow: hidden;
  }
  #camera-feed {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  #capture-canvas {
    display: none;
  }
  .result-card {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .history-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .history-item:hover {
    background-color: #f1f1f1;
  }
  .osmanlica-font {
    font-family: 'Lateef', serif;
    font-size: 1.5rem;
    text-align: right;
  }
  mark {
    background-color: #fffa8b;
    cursor: help;
  }
  .btn-group {
    margin-bottom: 10px;
  }
  @media(max-width:600px) {
    .camera-container {
      height: 200px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1 class="text-center my-4">Mezar TaÅŸÄ± Okuyucu GeliÅŸmiÅŸ <span aria-hidden="true">ðŸ“œ</span></h1>

  <div class="btn-group d-flex justify-content-between mb-2" role="group">
    <button id="start-camera-btn" class="btn btn-primary flex-grow-1 me-1">ðŸ“· Kamera AÃ§</button>
    <button id="switch-camera-btn" class="btn btn-secondary flex-grow-1 ms-1" disabled>ðŸ”„ Kamera DeÄŸiÅŸtir</button>
  </div>

  <div class="camera-container">
    <video id="camera-feed" autoplay muted playsinline></video>
  </div>

  <canvas id="capture-canvas" width="800" height="300"></canvas>

  <div class="d-grid gap-2 my-3">
    <button id="scan-btn" class="btn btn-success" disabled>ðŸ“¸ FotoÄŸraf Ã‡ek ve Tara</button>
  </div>

  <div class="d-grid gap-2 mb-3">
    <input type="file" id="file-input" accept="image/*" class="form-control" />
  </div>

  <div class="result-card">
    <h3>SonuÃ§:</h3>
    <div id="ocr-result" class="osmanlica-font">---</div>
    <div id="translation" class="mt-2">---</div>
    <div id="explanation" class="text-muted mt-2 small">---</div>
  </div>

  <h4 class="mt-4">Metin BÃ¶lÃ¼mleri</h4>
  <div class="result-card" id="text-sections" style="white-space: pre-wrap;">---</div>

  <h4 class="mt-4">GeÃ§miÅŸ KayÄ±tlar</h4>
  <div id="history" class="result-card"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script>
  const HISTORY_KEY = 'ocrHistory';

  let currentStream = null;
  let useFrontCamera = false; // Ã–n kamera (true) / arka kamera (false)

  // Basit OsmanlÄ±ca-TÃ¼rkÃ§e sÃ¶zlÃ¼k Ã¶rneÄŸi (geliÅŸtirilebilir)
  const sozluk = {
    "ÅžEYH": "DinÃ® lider, mÃ¼rÅŸid",
    "EFENDÄ°": "SaygÄ± ifadesi, bey",
    "PAÅžA": "AskerÃ® rÃ¼tbe",
    "BEY": "YÃ¶netici, bey",
    "HANIM": "KadÄ±nlar iÃ§in saygÄ±",
    "MEVLANA": "SaygÄ±deÄŸer, unvan",
    "SULTAN": "HÃ¼kÃ¼mdar, kraliyet unvanÄ±"
  };

  // Kamera baÅŸlatma fonksiyonu
  async function startCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }

    const constraints = {
      video: {
        facingMode: useFrontCamera ? "user" : "environment"
      }
    };

    try {
      currentStream = await navigator.mediaDevices.getUserMedia(constraints);
      const video = document.getElementById('camera-feed');
      video.srcObject = currentStream;
      document.getElementById('scan-btn').disabled = false;
      document.getElementById('switch-camera-btn').disabled = false;
      document.getElementById('start-camera-btn').textContent = "ðŸ“· Kamera Kapat";
    } catch (err) {
      alert("Kamera aÃ§Ä±lamadÄ±: " + err.message);
    }
  }

  // Kamera durdurma fonksiyonu
  function stopCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    const video = document.getElementById('camera-feed');
    video.srcObject = null;
    document.getElementById('scan-btn').disabled = true;
    document.getElementById('switch-camera-btn').disabled = true;
    document.getElementById('start-camera-btn').textContent = "ðŸ“· Kamera AÃ§";
  }

  // Kamera aÃ§/kapat butonu
  document.getElementById('start-camera-btn').addEventListener('click', () => {
    if (currentStream) {
      stopCamera();
    } else {
      startCamera();
    }
  });

  // Kamera deÄŸiÅŸtirme butonu
  document.getElementById('switch-camera-btn').addEventListener('click', () => {
    useFrontCamera = !useFrontCamera;
    startCamera();
  });

  // Hicri yÄ±lÄ± miladiye Ã§eviren basit fonksiyon (tahmini)
  function hicriToMiladi(hicriYil) {
    return 622 + Math.floor(hicriYil * 0.97);
  }

  // Kelime bazlÄ± vurgulama, tooltip ile
  function highlightWords(text) {
    // BÃ¼yÃ¼k harf olarak normalize et (basitÃ§e)
    const words = Object.keys(sozluk);
    let escapedText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    for (const word of words) {
      const regex = new RegExp(`\\b${word}\\b`, 'gi');
      escapedText = escapedText.replace(regex, (match) => {
        return `<mark title="${sozluk[word]}">${match}</mark>`;
      });
    }
    return escapedText;
  }

  // Ã‡ok satÄ±rlÄ± metni bÃ¶lme: isim, tarih, dua/metin
  function parseTextSections(text) {
    // SatÄ±rlara bÃ¶l
    const lines = text.trim().split(/\r?\n/).filter(l => l.trim() !== '');

    // Basit ayrÄ±m: ilk satÄ±r isim/unvan, iÃ§inde tarih geÃ§en satÄ±r tarih, kalanlar dua/metin
    let isimSatiri = '';
    let tarihSatiri = '';
    let duaSatirlari = [];

    for (const line of lines) {
      if (!isimSatiri && /[^\d]+/.test(line)) isimSatiri = line;
      else if (!tarihSatiri && /[Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©0-9]{3,4}/.test(line)) tarihSatiri = line;
      else duaSatirlari.push(line);
    }

    return {
      isim: isimSatiri,
      tarih: tarihSatiri,
      dua: duaSatirlari.join('\n')
    };
  }

  // OCR iÅŸlemi
  async function performOCR(imageDataURL) {
    document.getElementById('ocr-result').textContent = "TaranÄ±yor...";
    document.getElementById('translation').textContent = "---";
    document.getElementById('explanation').textContent = "---";
    document.getElementById('text-sections').textContent = "---";

    try {
      const worker = await Tesseract.createWorker({ logger: m => console.log(m) });
      await worker.loadLanguage('osd');
      await worker.initialize('osd');

      const { data: { text } } = await worker.recognize(imageDataURL);

      await worker.terminate();

      // Tarih algÄ±lama
      const hicriYil = (text.match(/[Ù¡-Ù©]{3,4}/g) || [])[0];
      const miladiTahmin = hicriYil ? hicriToMiladi(parseInt(hicriYil.replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d)))) : null;
      const explanation = miladiTahmin ? `Taranan yÄ±l: Hicri ${hicriYil} â‰ˆ Miladi ${miladiTahmin}` : "Taranan yazÄ±dan tarih Ã§Ä±karÄ±lamadÄ±.";

      // Kelimeleri vurgula
      const highlightedText = highlightWords(text.toUpperCase());

      // Ã‡ok satÄ±rlÄ± bÃ¶lÃ¼mlere ayÄ±r
      const sections = parseTextSections(text);

      // SonuÃ§larÄ± gÃ¼ncelle
      document.getElementById('ocr-result').innerHTML = highlightedText;
      document.getElementById('translation').textContent = "Not: Bu bir OCR Ã§Ä±ktÄ±sÄ±dÄ±r.";
      document.getElementById('explanation').textContent = explanation;

      document.getElementById('text-sections').innerHTML = `<b>Ä°sim / Ãœnvan:</b> ${sections.isim || '---'}\n<b>Tarih:</b> ${sections.tarih || '---'}\n<b>Dua / Metin:</b>\n${sections.dua || '---'}`;

      // GeÃ§miÅŸe ekle
      const item = document.createElement('div');
      item.className = 'history-item';
      item.textContent = "ðŸ“Œ Tarama - " + new Date().toLocaleTimeString();
      item.onclick = () => showHistory(text, "OCR Ã‡Ä±ktÄ±sÄ±", explanation, sections, highlightedText);
      document.getElementById('history').prepend(item);

      // Yerel depolama kaydÄ±
      const existing = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      existing.unshift({ text, explanation, time: new Date().toISOString(), sections, highlightedText });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(existing));

    } catch (err) {
      console.error(err);
      document.getElementById('ocr-result').textContent = "Hata oluÅŸtu.";
    }
  }

  // GeÃ§miÅŸten seÃ§im yapÄ±lÄ±nca gÃ¶ster
  function showHistory(text, translation, explanation, sections, highlightedText) {
    document.getElementById('ocr-result').innerHTML = highlightedText || text;
    document.getElementById('translation').textContent = "Ã‡eviri: " + translation;
    document.getElementById('explanation').textContent = "AÃ§Ä±klama: " + explanation;

    if (sections) {
      document.getElementById('text-sections').innerHTML = `<b>Ä°sim / Ãœnvan:</b> ${sections.isim || '---'}<br><b>Tarih:</b> ${sections.tarih || '---'}<br><b>Dua / Metin:</b><br>${sections.dua || '---'}`;
    } else {
      document.getElementById('text-sections').textContent = "---";
    }
  }

  // Kamera fotoÄŸraf Ã§ekip OCR yap
  async function captureAndScan() {
    if (!currentStream) {
      alert("LÃ¼tfen Ã¶nce kamerayÄ± aÃ§Ä±n.");
      return;
    }
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('capture-canvas');
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = canvas.toDataURL('image/png');
    await performOCR(imageData);
  }

  // Galeriden resim seÃ§imi yapÄ±nca
  document.getElementById('file-input').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async function(event) {
      const imageData = event.target.result;
      await performOCR(imageData);
    };
    reader.readAsDataURL(file);
  });

  // Scan butonuna tÄ±kla
  document.getElementById('scan-btn').addEventListener('click', captureAndScan);

  // Sayfa yÃ¼klendiÄŸinde geÃ§miÅŸi gÃ¶ster
  window.addEventListener('load', () => {
    const past = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    for (const item of past) {
      const div = document.createElement('div');
      div.className = 'history-item';
      div.textContent = "ðŸ“Œ Ã–nceki - " + new Date(item.time).toLocaleTimeString();
      div.onclick = () => showHistory(item.text, "OCR Ã‡Ä±ktÄ±sÄ±", item.explanation, item.sections, item.highlightedText);
      document.getElementById('history').appendChild(div);
    }
  });
</script>
</body>
</html>
