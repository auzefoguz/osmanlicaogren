<!-- head içine ekle -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // EmailJS Başlat
    emailjs.init('8BdNp7u1PufddSEM8');

    // Tema değiştirme fonksiyonu
    const setTheme = (theme) => {
        document.body.classList.remove('light-theme', 'dark-theme');
        document.body.classList.add(`${theme}-theme`);
        localStorage.setItem('osmanlicaTheme', theme);
        
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === theme);
        });
    };

    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            setTheme(btn.dataset.theme);
        });
    });

    const savedTheme = localStorage.getItem('osmanlicaTheme') || 'light';
    setTheme(savedTheme);

    // Hediye Premium Formu - EmailJS ile gönderim
    document.getElementById('hediyePremiumForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('arkadasEmail').value.trim();
        const alertBox = document.getElementById('hediyePremiumAlert');
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (!emailRegex.test(email)) {
            alertBox.style.display = 'block';
            alertBox.className = 'alert alert-danger';
            alertBox.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Lütfen geçerli bir e-posta adresi giriniz!';
            return;
        }

        const templateParams = {
            name: "Premium Hediye Sistemi",
            osmanlicaogren: "Premium Hediye Talebi",
            time: new Date().toLocaleString("tr-TR"),
            message: `Bir kullanıcı aşağıdaki e-posta adresine 1 ay ücretsiz Premium hediye etmek istiyor: ${email}`
        };

        emailjs.send("service_1avrv0q", "template_pc99ct6", templateParams)
        .then(() => {
            alertBox.style.display = 'block';
            alertBox.className = 'alert alert-success';
            alertBox.innerHTML = `<i class="bi bi-check-circle"></i> Hediye Premium başarıyla gönderildi! ${email} adresine bir davet maili yolladık.`;

            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('hediyePremiumModal')).hide();
                this.reset();
                alertBox.style.display = 'none';
            }, 2000);
        })
        .catch((error) => {
            alertBox.style.display = 'block';
            alertBox.className = 'alert alert-danger';
            alertBox.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Gönderim hatası: ${error.text || error}`;
        });
    });

    // Premium üyelik işlemleri
    document.getElementById('confirmPremium').addEventListener('click', function() {
        if (!document.getElementById('termsCheck').checked) {
            const alertBox = document.getElementById('premiumAlert');
            alertBox.style.display = 'block';
            alertBox.className = 'alert alert-danger';
            alertBox.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Lütfen hüküm ve koşulları kabul ediniz!';
            return;
        }

        const alertBox = document.getElementById('premiumAlert');
        alertBox.style.display = 'block';
        alertBox.className = 'alert alert-success';
        alertBox.innerHTML = '<i class="bi bi-check-circle"></i> Premium üyeliğiniz başarıyla başlatıldı! Yönlendiriliyorsunuz...';

        this.disabled = true;

        setTimeout(() => {
            const now = new Date();
            const renewalDate = new Date();
            renewalDate.setMonth(renewalDate.getMonth() + 1);
            
            localStorage.setItem('osmanlicaPremium', 'true');
            localStorage.setItem('subscriptionStartDate', now.toISOString());
            localStorage.setItem('subscriptionRenewalDate', renewalDate.toISOString());
            localStorage.removeItem('subscriptionCancelled');
            localStorage.removeItem('subscriptionExpired');
            
            updatePremiumStatus();
            bootstrap.Modal.getInstance(document.getElementById('premiumModal')).hide();
            alert("Premium üyeliğiniz aktif edildi! Artık tüm premium özelliklere erişebilirsiniz.");
        }, 1500);
    });

    // Aboneliği iptal et
    document.getElementById('cancelSubscription').addEventListener('click', function() {
        const alertBox = document.getElementById('subscriptionAlert');
        alertBox.style.display = 'block';
        alertBox.className = 'alert alert-info';
        alertBox.innerHTML = '<i class="bi bi-info-circle"></i> Aboneliğiniz iptal ediliyor...';
        
        setTimeout(() => {
            const renewalDate = new Date(localStorage.getItem('subscriptionRenewalDate'));
            localStorage.setItem('subscriptionCancelled', 'true');
            localStorage.setItem('validUntilDate', renewalDate.toISOString());
            
            alertBox.className = 'alert alert-success';
            alertBox.innerHTML = '<i class="bi bi-check-circle"></i> Aboneliğiniz başarıyla iptal edildi!';
            
            updatePremiumStatus();
            
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('subscriptionModal')).hide();
            }, 2000);
        }, 1500);
    });

    // Aboneliği yeniden aktif et
    document.getElementById('reactivateSubscription').addEventListener('click', function() {
        const alertBox = document.getElementById('subscriptionAlert');
        alertBox.style.display = 'block';
        alertBox.className = 'alert alert-info';
        alertBox.innerHTML = '<i class="bi bi-info-circle"></i> Aboneliğiniz yeniden aktif ediliyor...';
        
        setTimeout(() => {
            const now = new Date();
            const renewalDate = new Date();
            renewalDate.setMonth(renewalDate.getMonth() + 1);
            
            localStorage.setItem('osmanlicaPremium', 'true');
            localStorage.setItem('subscriptionRenewalDate', renewalDate.toISOString());
            localStorage.removeItem('subscriptionCancelled');
            localStorage.removeItem('subscriptionExpired');
            localStorage.removeItem('validUntilDate');
            
            alertBox.className = 'alert alert-success';
            alertBox.innerHTML = '<i class="bi bi-check-circle"></i> Aboneliğiniz yeniden aktif edildi!';
            
            updatePremiumStatus();
            
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('subscriptionModal')).hide();
            }, 2000);
        }, 1500);
    });

    // Premium durumunu güncelleme fonksiyonu
    const updatePremiumStatus = () => {
        const isPremium = localStorage.getItem('osmanlicaPremium') === 'true';
        const isCancelled = localStorage.getItem('subscriptionCancelled') === 'true';
        const isExpired = localStorage.getItem('subscriptionExpired') === 'true';
        const premiumButton = document.getElementById('premiumButton');
        const premiumButtonText = document.getElementById('premiumButtonText');
        const subscriptionManagement = document.getElementById('subscriptionManagement');
        
        if (isPremium && !isExpired) {
            premiumButtonText.textContent = 'Premium Aktif';
            premiumButton.classList.remove('btn-warning');
            premiumButton.classList.add('btn-success');
            premiumButton.disabled = true;
            
            subscriptionManagement.innerHTML = '';
            const manageBtn = document.createElement('button');
            manageBtn.className = 'btn btn-outline-info w-100';
            manageBtn.innerHTML = '<i class="bi bi-credit-card"></i> Aboneliği Yönet';
            manageBtn.setAttribute('data-bs-toggle', 'modal');
            manageBtn.setAttribute('data-bs-target', '#subscriptionModal');
            subscriptionManagement.appendChild(manageBtn);
        } else {
            premiumButtonText.textContent = 'Premium\'a Geç';
            premiumButton.classList.add('btn-warning');
            premiumButton.classList.remove('btn-success', 'disabled');
            premiumButton.disabled = false;
            subscriptionManagement.innerHTML = '';
        }
        
        updateSubscriptionStatus();
    };
    
    // Abonelik durumunu güncelle
    const updateSubscriptionStatus = () => {
        const isPremium = localStorage.getItem('osmanlicaPremium') === 'true';
        const isCancelled = localStorage.getItem('subscriptionCancelled') === 'true';
        const renewalDate = new Date(localStorage.getItem('subscriptionRenewalDate') || new Date());
        const nextPaymentDate = new Date(renewalDate);
        nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
        const validUntilDate = localStorage.getItem('validUntilDate') ? new Date(localStorage.getItem('validUntilDate')) : null;
        const now = new Date();
        
        const formatDate = (date) => {
            return date.toLocaleDateString('tr-TR', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
        };
        
        document.getElementById('renewalDate').textContent = formatDate(renewalDate);
        document.getElementById('nextPaymentDate').textContent = formatDate(nextPaymentDate);
        
        if (validUntilDate) {
            document.getElementById('validUntil').textContent = formatDate(validUntilDate);
            document.getElementById('validUntilText').style.display = 'block';
        } else {
            document.getElementById('validUntilText').style.display = 'none';
        }
        
        if (!isPremium) {
            document.getElementById('statusText').textContent = 'Aktif Değil';
            document.getElementById('statusText').className = 'badge bg-secondary subscription-badge';
            document.getElementById('cancelledText').style.display = 'none';
            document.getElementById('expiredText').style.display = 'none';
            document.getElementById('cancelSubscription').style.display = 'none';
            document.getElementById('reactivateSubscription').style.display = 'inline-block';
            document.getElementById('subscriptionWarning').style.display = 'none';
        } 
        else if (isCancelled) {
            document.getElementById('statusText').textContent = 'Aktif';
            document.getElementById('statusText').className = 'badge bg-warning subscription-badge';
            document.getElementById('cancelledText').style.display = 'inline';
            document.getElementById('expiredText').style.display = 'none';
            document.getElementById('cancelSubscription').style.display = 'none';
            document.getElementById('reactivateSubscription').style.display = 'inline-block';
            document.getElementById('subscriptionWarning').style.display = 'block';
            
            if (validUntilDate && now > validUntilDate) {
                localStorage.setItem('subscriptionExpired', 'true');
                localStorage.removeItem('osmanlicaPremium');
                document.getElementById('statusText').textContent = 'Sona Erdi';
                document.getElementById('statusText').className = 'badge bg-secondary subscription-badge';
                document.getElementById('cancelledText').style.display = 'none';
                document.getElementById('expiredText').style.display = 'inline';
                document.getElementById('reactivateSubscription').style.display = 'none';
                updatePremiumStatus();
            }
        } 
        else {
            document.getElementById('statusText').textContent = 'Aktif';
            document.getElementById('statusText').className = 'badge bg-success subscription-badge';
            document.getElementById('cancelledText').style.display = 'none';
            document.getElementById('expiredText').style.display = 'none';
            document.getElementById('cancelSubscription').style.display = 'inline-block';
            document.getElementById('reactivateSubscription').style.display = 'none';
            document.getElementById('subscriptionWarning').style.display = 'block';
        }
    };

    updatePremiumStatus();

    document.getElementById('premiumModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('premiumAlert').style.display = 'none';
        document.getElementById('termsCheck').checked = false;
        document.getElementById('confirmPremium').disabled = false;
    });

    document.getElementById('hediyePremiumModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('hediyePremiumAlert').style.display = 'none';
        document.getElementById('hediyePremiumForm').reset();
    });

    document.getElementById('subscriptionModal').addEventListener('hidden.bs.modal', () => {
        document.getElementById('subscriptionAlert').style.display = 'none';
    });
});
</script>

